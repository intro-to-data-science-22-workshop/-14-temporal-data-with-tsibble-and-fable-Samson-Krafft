---
title: "Presentation Code"
author: ""
date: "`r format(Sys.time(), '%B %d, %Y | %H:%M:%S | %Z')`"
output:
  html_document:
    code_folding: show
    df_print: paged
    highlight: tango
    number_sections: no
    theme: cosmo
    toc: no
editor_options: 
  markdown: 
    wrap: 72
---

```{=html}
<style>
div.answer {background-color:#f3f0ff; border-radius: 5px; padding: 20px;}
</style>
```
```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      eval = TRUE,
                      error = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      comment = NA)
```

------------------------------------------------------------------------

### Workshop Packages

```{r, include = T}
library(tsibble)
library(fable)
library(tsibbledata)
```

### Supplementary Packages

```{r}
library(tidyverse)
library(lubridate)
library(ggplot2)
library(urca)
```

<br>

------------------------------------------------------------------------

# Tsibble Code

**Important concepts** - tsibble object - index variable - key
variable - multiple time series in one tsibble object - time class
function

**functions used**: - tsibble() - mutate() + yearmonth() - autoplot()
from ggplot2

## Object creation with 'tsibble()'

```{r}
# Create a tsibble object from scratch
y <- tsibble(
  Year = 2015:2019,
  Observation = c(123, 5, 78, 7, 110),
  index = Year
)

y
```

## Object creation with 'as_tsibble()'

```{r}
weather <- nycflights13::weather %>% 
  select(origin, time_hour, temp, humid, precip)
weather_tsbl <- as_tsibble(weather, key = origin, index = time_hour)

weather_tsbl
```

```{r}
# convert "monthly/weekly/daily" data into tsibble object
z <- data.frame(Month = c("2022 Jan", "2022 Feb", "2022 Mar", "2022 Apr", "2022 May"),
                Observations = c(50, 23, 34, 30, 25))

z %>%
  mutate(Month = yearmonth(Month)) %>%
  as_tsibble(index = Month)
```

```{r}
# Time plots
melsyd_economy <- ansett %>%
  filter(Airports == "MEL-SYD", Class == "Economy") %>%
  mutate(Passengers = Passengers/1000)
autoplot(melsyd_economy, Passengers) +
  labs(title = "Ansett airlines economy class",
       subtitle = "Melbourne-Sydney",
       y = "Passengers ('000)")
```

# Fable

**Important concepts** - Model specification - Model estimation

**functions used**: - model() - report()

```{r}
tourism
```

```{r}
# Data Manipulation
tourism_t_trips <- tourism %>% 
  summarise(Trips = sum(Trips))
tourism_t_trips
```

```{r}
# Data Exploration

tourism_total_trips %>% 
  autoplot(Trips)
```

What can we see? There is seasonality and a negative trend that turns
positive after 2010. As experienced forecasters, we know that under such
conditions, we should choose a exponential smoothing model.

```{r}
# Comparing multiple models
fit <- tourism_t_trips %>% 
  model(
    ets = ETS(Trips),
    arima = ARIMA(Trips),
    lm = TSLM(Trips ~ trend() + season())
  )

# plot forecast
fit %>% 
  forecast(h = "2 years") %>% 
  autoplot(tourism_t_trips, level = 80, alpha = 0.5)
```

# Scaling up even further (not included on the slides)

```{r}
fit <- tourism_t_trips %>% 
  model(
    ets = ETS(Trips),
    arima = ARIMA(Trips),
    lm = TSLM(Trips ~ trend(knots = yearquarter("2010 Q1")) + season())
  )

fit %>% 
  forecast(h = "2 years") %>% 
  autoplot(tourism_t_trips, level = 80, alpha = 0.5)
```

```{r}
accuracy(fit)
```

```{r}
tourism_t_trips %>% 
  # Withhold the last 3 years before fitting the model
  filter(Quarter < yearquarter("2015 Q1")) %>% 
  # Estimate the models on the training data (1998-2014)
  model(
    ets = ETS(Trips),
    arima = ARIMA(Trips),
    lm = TSLM(Trips ~ trend(knots = yearquarter("2010 Q1")) + season())
  ) %>% 
  # Forecast the witheld time peroid (2015-2017)
  forecast(h = "3 years") %>% 
  # Compute accuracy of the forecasts relative to the actual data 
  accuracy(tourism_t_trips)
```

```{r}
fit <- tourism_t_trips %>% 
  model(
    ets = ETS(Trips),
    arima = ARIMA(Trips)
  ) %>% 
  mutate(
    average = (ets + arima) / 2
  )

fit %>% 
  forecast(h = "2 years") %>% 
  autoplot(tourism_t_trips, level = 80, alpha = 0.5)
```

```{r}
tourism_state <- tourism %>% 
  group_by(State) %>% 
  summarise(Trips = sum(Trips))
tourism_state
```

```{r}
tourism_state %>% 
  autoplot(Trips)
```

```{r}
fit <- tourism_state %>% 
  model(
    ets = ETS(Trips),
    arima = ARIMA(Trips)
  ) %>% 
  mutate(
    average = (ets + arima)/2
  )
fit
```

```{r}
fit %>% 
  forecast(h = "2 years") %>% 
  autoplot(tourism_state, level = NULL)
```
